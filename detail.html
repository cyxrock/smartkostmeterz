<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Detail Monitoring Penghuni</title>
    <link rel="stylesheet" href="style.css" />
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body>
    <div class="container">
        <h2>Detail Monitoring: <span id="detailUser"></span></h2>
        <p>Data penggunaan listrik dan riwayat pembayaran untuk penghuni yang dipilih.</p>

        <h3 style="margin-top:30px;">Monitoring Real-time</h3>
        <table class="monitoring-table" id="detailMonitoringTable">
            <thead>
                <tr>
                    <th>Parameter</th>
                    <th>Nilai</th>
                    <th>Satuan</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>

        <h3 style="margin-top:30px;">Riwayat Pembayaran (Struk)</h3>
        <div id="paymentHistory">
            </div>

        <div class="button-group" style="margin-top:40px;">
            <a href="admin.html" class="btn btn-back">ðŸ”™ Kembali ke Dashboard Admin</a>
        </div>
    </div>

    <script>
        // Inisialisasi Firebase
        if (!firebase.apps.length) {
            const firebaseConfig = {
                apiKey: "AIzaSyAlDGfYUsGyPiL41m1qHrQxSRXihI8xuG8",
                authDomain: "smartkos13.firebaseapp.com",
                projectId: "smartkos13",
                storageBucket: "smartkos13.firebasestorage.app",
                messagingSenderId: "240191503170",
                appId: "1:240191503170:web:bf169151c9a2ad098d66db",
                measurementId: "G-H6FY9Q7SLS"
            };
            firebase.initializeApp(firebaseConfig);
        }
        const database = firebase.database();

        // Ambil nama pengguna dari URL (misal: user=kamar1)
        const urlParams = new URLSearchParams(window.location.search);
        const detailUser = urlParams.get('user'); 
        document.getElementById('detailUser').textContent = detailUser;

        const detailMonitoringBody = document.querySelector('#detailMonitoringTable tbody');
        const paymentHistoryDiv = document.getElementById('paymentHistory');

        // Fungsi format angka (tetap menggunakan 2 desimal untuk sebagian besar parameter)
        function fmt(n) { 
            // console.log(`DEBUG [detail.html]: fmt() menerima nilai: ${n}, tipe: ${typeof n}`); 
            return (typeof n === 'number') ? n.toFixed(2) : 'N/A'; 
        }

        // Dengarkan perubahan data untuk pengguna spesifik di Firebase
        if (detailUser) {
            database.ref(detailUser).on('value', snapshot => {
                const userData = snapshot.val();
                // console.log("DEBUG [detail.html]: Data mentah dari Firebase untuk detail user:", userData); // Debug seluruh data

                if (userData) {
                    const meteran = userData.meteran || {}; // Pastikan meteran adalah objek atau kosong
                    // console.log("DEBUG [detail.html]: Objek 'meteran' yang diterima:", meteran); // Debug objek meteran

                    // --- BAGIAN PENTING: Mendapatkan & Mengkonversi Energi ---
                    // Coba ambil energi dari 'energi_bulanan'. Sertakan fallback ke 'energi' jika belum ada
                    let energyWhFromFirebase = meteran.energi_bulanan; 
                    if (energyWhFromFirebase === undefined && meteran.energi !== undefined) {
                        energyWhFromFirebase = meteran.energi;
                        // console.log("DEBUG [detail.html]: Menggunakan fallback 'energi' karena 'energi_bulanan' tidak ditemukan."); // DEBUG
                    }
                    // console.log("DEBUG [detail.html]: energyWhFromFirebase (nilai mentah dari Firebase):", energyWhFromFirebase);

                    // Konversi Wh ke kWh hanya jika nilai yang didapat adalah angka, jika tidak set 0
                    const energyKWh = (typeof energyWhFromFirebase === 'number') ? energyWhFromFirebase / 1000.0 : 0;
                    // console.log("DEBUG [detail.html]: energyKWh (setelah konversi):", energyKWh);
                    // --- AKHIR BAGIAN ENERGI ---

                    detailMonitoringBody.innerHTML = '';
                    const monitoringRows = [
                        ['Tegangan', fmt(meteran.tegangan), 'Volt (V)'],
                        ['Arus', fmt(meteran.arus), 'Ampere (A)'],
                        ['Daya Aktif', fmt(meteran.daya_aktif), 'Watt (W)'],
                        ['Frekuensi', fmt(meteran.frekuensi), 'Hertz (Hz)'],
                        ['Faktor Daya', fmt(meteran.faktor_daya), ''],
                        // Tampilkan energi yang sudah dikonversi ke kWh dengan 4 desimal
                        // Pastikan menggunakan toFixed(4) dan jika bukan angka tetap 'N/A'
                        ['Energi Bulanan', (typeof energyKWh === 'number') ? energyKWh.toFixed(4) : 'N/A', 'kWh'] 
                    ];

                    monitoringRows.forEach(r => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td>`;
                        detailMonitoringBody.appendChild(tr);
                    });

                    // --- BAGIAN RIWAYAT PEMBAYARAN ---
                    // console.log("DEBUG [detail.html]: Objek 'payments' yang diterima:", userData.payments); // Debug payments object

                    if (userData.payments) {
                        updatePaymentHistory(userData.payments);
                    } else {
                        paymentHistoryDiv.innerHTML = '<p>Riwayat pembayaran tidak ditemukan.</p>';
                        // console.log("DEBUG [detail.html]: userData.payments tidak ditemukan atau kosong."); // DEBUG
                    }
                    // --- AKHIR RIWAYAT PEMBAYARAN ---

                } else {
                    detailMonitoringBody.innerHTML = '<tr><td colspan="3">Data monitoring tidak tersedia untuk pengguna ini.</td></tr>';
                    paymentHistoryDiv.innerHTML = '<p>Data pengguna tidak ditemukan.</p>';
                    // console.log("DEBUG [detail.html]: userData tidak ditemukan untuk:", detailUser); // DEBUG
                }
            });
        } else {
            detailMonitoringBody.innerHTML = '<tr><td colspan="3">Pengguna tidak ditentukan.</td></tr>';
            paymentHistoryDiv.innerHTML = '<p>Pengguna tidak ditentukan.</p>';
        }

        // Fungsi untuk memperbarui riwayat pembayaran (sudah diperbaiki sedikit)
        function updatePaymentHistory(userPayments) {
            paymentHistoryDiv.innerHTML = '';
            // Pastikan userPayments adalah objek sebelum memprosesnya
            if (typeof userPayments !== 'object' || userPayments === null) {
                // console.log("DEBUG [detail.html]: userPayments bukan objek atau null, tidak bisa memproses riwayat.");
                paymentHistoryDiv.innerHTML = '<p>Riwayat pembayaran tidak valid.</p>';
                return;
            }

            const paymentArray = Object.keys(userPayments).map(key => ({ ...userPayments[key], id: key }));
            // console.log("DEBUG [detail.html]: paymentArray (setelah konversi dari objek):", paymentArray); // DEBUG

            if (paymentArray.length > 0) {
                // Urutkan pembayaran berdasarkan timestamp (terbaru akan di atas)
                const sortedPaymentHistory = [...paymentArray].sort((a, b) => {
                    // Jika ada timestamp dari Firebase, gunakan itu. Jika tidak, gunakan tanggal/jam
                    const timeA = a.timestamp || new Date(`${a.bulan} ${a.tanggal}, ${a.tahun} ${a.jam || '00:00:00'}`).getTime();
                    const timeB = b.timestamp || new Date(`${b.bulan} ${b.tanggal}, ${b.tahun} ${b.jam || '00:00:00'}`).getTime();
                    return timeB - timeA; // Urutkan dari terbaru ke terlama
                });

                sortedPaymentHistory.forEach(p => {
                    const struk = document.createElement('div');
                    struk.classList.add('payment-receipt');
                    struk.innerHTML = `
                        <p><strong>Waktu Konfirmasi:</strong> ${p.tanggal} ${p.bulan} ${p.tahun}, Jam ${p.jam || 'N/A'} WITA</p>
                        <p><strong>Nominal Tagihan:</strong> Rp${(typeof p.nominal === 'number' ? p.nominal : 0).toLocaleString('id-ID')}</p>
                        <p><strong>Status:</strong> <span class="relay-status paid">SUDAH BAYAR</span></p>
                    `;
                    paymentHistoryDiv.appendChild(struk);
                });
            } else {
                paymentHistoryDiv.innerHTML = '<p>Riwayat pembayaran tidak ditemukan.</p>';
                // console.log("DEBUG [detail.html]: paymentArray kosong."); // DEBUG
            }
        }

        // Logout
        document.getElementById('logoutBtn').onclick = e => {
            e.preventDefault();
            localStorage.removeItem('role');
            localStorage.removeItem('username');
            window.location.href = 'index.html';
        };
    </script>
</body>
</html>