<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Detail Monitoring Penghuni</title>
    <link rel="stylesheet" href="style.css" />
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <h2>Detail Monitoring: <span id="detailUser"></span></h2>
        <p>Data penggunaan listrik dan riwayat pembayaran untuk penghuni yang dipilih.</p>

        <h3 style="margin-top:30px;">Monitoring Real-time</h3>
        <div class="monitoring-table-container">
            <table class="monitoring-table" id="detailMonitoringTable">
                <thead>
                    <tr>
                        <th>Parameter</th>
                        <th>Nilai</th>
                        <th>Satuan</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>

        <h3 style="margin-top: 30px;">Grafik Pemakaian Daya Aktif (Watt)</h3>
        <canvas id="powerChart"></canvas>
        
        <h3 style="margin-top: 30px;">Grafik Tegangan (Volt)</h3>
        <canvas id="voltageChart"></canvas>

        <h3 style="margin-top: 30px;">Grafik Arus (Ampere)</h3>
        <canvas id="currentChart"></canvas>

        <h3 style="margin-top: 30px;">Grafik Energi Bulanan (kWh)</h3>
        <canvas id="energyChart"></canvas>

        <h3 style="margin-top:30px;">Riwayat Pembayaran (Struk)</h3>
        <div id="paymentHistory">
            </div>

        <div class="button-group" style="margin-top:40px;">
            <a href="admin.html" class="btn btn-back">ðŸ”™ Kembali ke Dashboard Admin</a>
        </div>
    </div>

    <script>
        // Inisialisasi Firebase
        if (!firebase.apps.length) {
            const firebaseConfig = {
                apiKey: "AIzaSyAlDGfYUsGyPiL41m1qHrQxSRXihI8xuG8",
                authDomain: "smartkos13.firebaseapp.com",
                projectId: "smartkos13",
                storageBucket: "smartkos13.firebasestorage.app",
                messagingSenderId: "240191503170",
                appId: "1:240191503170:web:bf169151c9a2ad098d66db",
                measurementId: "G-H6FY9Q7SLS"
            };
            firebase.initializeApp(firebaseConfig);
        }
        const database = firebase.database();

        // Ambil nama pengguna dari URL (misal: user=kamar1)
        const urlParams = new URLSearchParams(window.location.search);
        const detailUser = urlParams.get('user');
        document.getElementById('detailUser').textContent = detailUser;

        const detailMonitoringBody = document.querySelector('#detailMonitoringTable tbody');
        const paymentHistoryDiv = document.getElementById('paymentHistory');

        // Konteks grafik
        const powerChartCtx = document.getElementById('powerChart').getContext('2d');
        const voltageChartCtx = document.getElementById('voltageChart').getContext('2d');
        const currentChartCtx = document.getElementById('currentChart').getContext('2d');
        const energyChartCtx = document.getElementById('energyChart').getContext('2d');
        
        let powerChart;
        let voltageChart;
        let currentChart;
        let energyChart;
        
        let chartDataPoints = {
            power: [],
            voltage: [],
            current: [],
            energy: []
        };

        // Fungsi format angka (tetap menggunakan 2 desimal untuk sebagian besar parameter)
        function fmt(n) {
            return (typeof n === 'number') ? n.toFixed(2) : 'N/A';
        }
        
        // Fungsi untuk memperbarui grafik
        function updateChart(chart, ctx, label, data, borderColor, unit) {
            const labels = chartDataPoints[data].map(p => p.x);
            const dataValues = chartDataPoints[data].map(p => p.y);

            if (chart) {
                chart.data.labels = labels;
                chart.data.datasets[0].data = dataValues;
                chart.update();
            } else {
                chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: `${label} (${unit})`,
                            data: dataValues,
                            borderColor: borderColor,
                            tension: 0.1,
                            fill: false
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: `${label} (${unit})`
                                }
                            }
                        }
                    }
                });
            }
            return chart;
        }

        // Dengarkan perubahan data untuk pengguna spesifik di Firebase
        if (detailUser) {
            database.ref(detailUser).on('value', snapshot => {
                const userData = snapshot.val();

                if (userData) {
                    const meteran = userData.meteran || {};
                    let energyWhFromFirebase = meteran.energi_bulanan;
                    if (energyWhFromFirebase === undefined && meteran.energi !== undefined) {
                        energyWhFromFirebase = meteran.energi;
                    }
                    const energyKWh = (typeof energyWhFromFirebase === 'number') ? energyWhFromFirebase / 1000.0 : 0;

                    detailMonitoringBody.innerHTML = '';
                    const monitoringRows = [
                        ['Tegangan', fmt(meteran.tegangan), 'Volt (V)'],
                        ['Arus', fmt(meteran.arus), 'Ampere (A)'],
                        ['Daya Aktif', fmt(meteran.daya_aktif), 'Watt (W)'],
                        ['Frekuensi', fmt(meteran.frekuensi), 'Hertz (Hz)'],
                        ['Faktor Daya', fmt(meteran.faktor_daya), ''],
                        ['Energi Bulanan', (typeof energyKWh === 'number') ? energyKWh.toFixed(4) : 'N/A', 'kWh']
                    ];

                    monitoringRows.forEach(r => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td>`;
                        detailMonitoringBody.appendChild(tr);
                    });

                    // Perbarui Data untuk Semua Grafik
                    const now = new Date();
                    const timeLabel = now.toLocaleTimeString();

                    chartDataPoints.power.push({ x: timeLabel, y: meteran.daya_aktif || 0 });
                    chartDataPoints.voltage.push({ x: timeLabel, y: meteran.tegangan || 0 });
                    chartDataPoints.current.push({ x: timeLabel, y: meteran.arus || 0 });
                    chartDataPoints.energy.push({ x: timeLabel, y: energyKWh });
                    
                    const maxDataPoints = 10;
                    if (chartDataPoints.power.length > maxDataPoints) chartDataPoints.power.shift();
                    if (chartDataPoints.voltage.length > maxDataPoints) chartDataPoints.voltage.shift();
                    if (chartDataPoints.current.length > maxDataPoints) chartDataPoints.current.shift();
                    if (chartDataPoints.energy.length > maxDataPoints) chartDataPoints.energy.shift();

                    // Perbarui atau buat grafik
                    powerChart = updateChart(powerChart, powerChartCtx, 'Daya Aktif', 'power', 'rgb(75, 192, 192)', 'Watt');
                    voltageChart = updateChart(voltageChart, voltageChartCtx, 'Tegangan', 'voltage', 'rgb(54, 162, 235)', 'Volt');
                    currentChart = updateChart(currentChart, currentChartCtx, 'Arus', 'current', 'rgb(255, 159, 64)', 'Ampere');
                    energyChart = updateChart(energyChart, energyChartCtx, 'Energi Bulanan', 'energy', 'rgb(153, 102, 255)', 'kWh');

                    if (userData.payments) {
                        updatePaymentHistory(userData.payments);
                    } else {
                        paymentHistoryDiv.innerHTML = '<p>Riwayat pembayaran tidak ditemukan.</p>';
                    }
                } else {
                    detailMonitoringBody.innerHTML = '<tr><td colspan="3">Data monitoring tidak tersedia untuk pengguna ini.</td></tr>';
                    paymentHistoryDiv.innerHTML = '<p>Data pengguna tidak ditemukan.</p>';
                }
            });
        } else {
            detailMonitoringBody.innerHTML = '<tr><td colspan="3">Pengguna tidak ditentukan.</td></tr>';
            paymentHistoryDiv.innerHTML = '<p>Pengguna tidak ditentukan.</p>';
        }

        // Fungsi untuk memperbarui riwayat pembayaran
        function updatePaymentHistory(userPayments) {
            paymentHistoryDiv.innerHTML = '';
            if (typeof userPayments !== 'object' || userPayments === null) {
                paymentHistoryDiv.innerHTML = '<p>Riwayat pembayaran tidak valid.</p>';
                return;
            }

            const paymentArray = Object.keys(userPayments).map(key => ({ ...userPayments[key], id: key }));
            if (paymentArray.length > 0) {
                const sortedPaymentHistory = [...paymentArray].sort((a, b) => {
                    const timeA = a.timestamp || new Date(`${a.bulan} ${a.tanggal}, ${a.tahun} ${a.jam || '00:00:00'}`).getTime();
                    const timeB = b.timestamp || new Date(`${b.bulan} ${b.tanggal}, ${b.tahun} ${b.jam || '00:00:00'}`).getTime();
                    return timeB - timeA;
                });

                sortedPaymentHistory.forEach(p => {
                    const struk = document.createElement('div');
                    struk.classList.add('payment-receipt');
                    struk.innerHTML = `
                        <p><strong>Waktu Konfirmasi:</strong> ${p.tanggal} ${p.bulan} ${p.tahun}, Jam ${p.jam || 'N/A'} WITA</p>
                        <p><strong>Nominal Tagihan:</strong> Rp${(typeof p.nominal === 'number' ? p.nominal : 0).toLocaleString('id-ID')}</p>
                        <p><strong>Status:</strong> <span class="relay-status paid">SUDAH BAYAR</span></p>
                    `;
                    paymentHistoryDiv.appendChild(struk);
                });
            } else {
                paymentHistoryDiv.innerHTML = '<p>Riwayat pembayaran tidak ditemukan.</p>';
            }
        }

        // Logout
        document.getElementById('logoutBtn').onclick = e => {
            e.preventDefault();
            localStorage.removeItem('role');
            localStorage.removeItem('username');
            window.location.href = 'index.html';
        };
    </script>
</body>
</html>
