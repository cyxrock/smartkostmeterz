<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Konfirmasi Pembayaran</title>
    <link rel="stylesheet" href="style.css" />
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body>
    <div class="container">
        <h2>Konfirmasi Pembayaran Anda</h2>
        <div id="paymentNotification" class="notification-message" style="transition: opacity 0.5s; opacity:0; display:none;"></div>
        
        <div class="payment-details" style="text-align:center;">
            <p id="paymentInfo"></p>
            <p id="billAmount" style="font-size: 2em; font-weight: bold; margin: 10px 0;"></p>
            <p>Dengan menekan tombol di bawah, Anda mengonfirmasi bahwa Anda telah melakukan pembayaran.</p>
            <p style="font-size: 0.8em; color: #aaa;">Status listrik akan diatur oleh admin setelah verifikasi pembayaran.</p>
        </div>

        <div class="button-group vertical">
            <button class="btn" id="confirmPaymentBtn">Ya, Saya Sudah Bayar</button>
            <a href="#" class="btn btn-back" id="backToDashboard">Kembali</a>
        </div>
    </div>

    <script>
        // Inisialisasi Firebase
        if (!firebase.apps.length) {
            const firebaseConfig = {
                apiKey: "AIzaSyAlDGfYUsGyPiL41m1qHrQxSRXihI8xuG8",
                authDomain: "smartkos13.firebaseapp.com",
                projectId: "smartkos13",
                storageBucket: "smartkos13.firebasestorage.app",
                messagingSenderId: "240191503170",
                appId: "1:240191503170:web:bf169151c9a2ad098d66db",
                measurementId: "G-H6FY9Q7SLS"
            };
            firebase.initializeApp(firebaseConfig);
        }
        const database = firebase.database();

        const paymentInfoEl = document.getElementById('paymentInfo');
        const billAmountEl = document.getElementById('billAmount');
        const confirmPaymentBtn = document.getElementById('confirmPaymentBtn');
        const backBtn = document.getElementById('backToDashboard');
        const notificationEl = document.getElementById('paymentNotification');

        const urlParams = new URLSearchParams(window.location.search);
        const user = urlParams.get('user');
        const amount = urlParams.get('amount');

        if (user && amount) {
            paymentInfoEl.textContent = `Anda akan mengkonfirmasi pembayaran untuk ${user}.`;
            billAmountEl.textContent = `Rp${Number(amount).toLocaleString('id-ID')}`;
            
            // Atur tombol kembali ke dashboard user
            backBtn.href = `user.html?user=${encodeURIComponent(user)}`;

            confirmPaymentBtn.addEventListener('click', () => {
                confirmPaymentBtn.disabled = true;
                confirmPaymentBtn.textContent = 'Memproses...';

                // Dapatkan tanggal dan waktu saat ini
                const now = new Date();
                const day = now.getDate();
                const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
                const month = monthNames[now.getMonth()];
                const year = now.getFullYear();
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const seconds = String(now.getSeconds()).padStart(2, '0');

                // Buat objek pembayaran
                const paymentData = {
                    nominal: Number(amount),
                    tanggal: day,
                    bulan: month,
                    tahun: year,
                    jam: `${hours}:${minutes}:${seconds}`,
                    timestamp: firebase.database.ServerValue.TIMESTAMP // Tambahkan timestamp untuk pengurutan
                };

                // Kirim data pembayaran ke Firebase di bawah node 'payments' untuk user terkait
                // !!! PENTING: TIDAK ADA PERUBAHAN STATUS RELAY DI SINI !!!
                database.ref(`${user}/payments`).push(paymentData)
                    .then(() => {
                        notificationEl.textContent = 'Konfirmasi pembayaran berhasil dikirim. Admin akan segera memverifikasi.';
                        notificationEl.style.backgroundColor = '#28a745'; // Hijau untuk sukses
                        notificationEl.style.display = 'block';
                        notificationEl.style.opacity = '1';

                        confirmPaymentBtn.style.display = 'none';
                        backBtn.style.display = 'none';

                        setTimeout(() => {
                            window.location.href = `user.html?user=${encodeURIComponent(user)}`;
                        }, 3000);
                    })
                    .catch(error => {
                        console.error("Error mengirim konfirmasi pembayaran:", error); // DEBUG
                        notificationEl.textContent = 'Gagal mengirim konfirmasi pembayaran. Coba lagi.';
                        notificationEl.style.backgroundColor = '#dc3545'; // Merah untuk error
                        notificationEl.style.display = 'block';
                        notificationEl.style.opacity = '1';
                        confirmPaymentBtn.disabled = false;
                        confirmPaymentBtn.textContent = 'Ya, Saya Sudah Bayar';
                    });
            });

        } else {
            paymentInfoEl.textContent = 'Informasi tagihan tidak ditemukan.';
            confirmPaymentBtn.style.display = 'none';
            backBtn.textContent = 'Kembali ke Login';
            backBtn.href = 'index.html';
        }
    </script>
</body>
</html>
