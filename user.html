<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dashboard Penghuni</title>
    <link rel="stylesheet" href="style.css" />
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <h2 class="monitoring-title">Halo, <span id="userName"></span>!</h2>
        <p>Berikut adalah informasi listrik dan tagihan bulanan Anda.</p>
        
        <div id="relayStatusInfo" class="monitoring-footer">Memuat status listrik...</div>

        <h3 style="margin-top:30px;">Monitoring Pemakaian Listrik</h3>
        <div class="monitoring-table-container">
            <table class="monitoring-table" id="monitoringTable">
                <thead>
                    <tr>
                        <th>Parameter</th>
                        <th>Nilai</th>
                        <th>Satuan</th>
                    </tr>
                </thead>
                <tbody id="monitoringBody">
                    </tbody>
            </table>
        </div>
        <h3 style="margin-top: 30px;">Grafik Pemakaian Daya Aktif (Watt)</h3>
        <canvas id="powerChart"></canvas>

        <h3 style="margin-top: 30px;">Grafik Tegangan (Volt)</h3>
        <canvas id="voltageChart"></canvas>

        <h3 style="margin-top: 30px;">Grafik Arus (Ampere)</h3>
        <canvas id="currentChart"></canvas>

        <h3 style="margin-top: 30px;">Grafik Energi Bulanan (kWh)</h3>
        <canvas id="energyChart"></canvas>

        <div class="payment-receipt" style="margin-top: 30px; text-align: center;">
            <p>Estimasi Tagihan Bulan Ini:</p>
            <h3 id="billAmount" style="font-size: 2.5em; margin: 10px 0;">Menghitung...</h3>
            <p id="usageInfo" style="font-size: 0.9em;">Menunggu data dari meteran...</p>
        </div>

        <div class="button-group vertical">
            <a href="#" id="paymentBtn" class="btn" style="display:none;">‚úîÔ∏è Konfirmasi Pembayaran</a>
            <a href="#" id="logoutBtn" class="btn btn-back">üîô Logout</a>
        </div>
    </div>

    <script>
        // Inisialisasi Firebase
        if (!firebase.apps.length) {
            const firebaseConfig = {
                apiKey: "AIzaSyAlDGfYUsGyPiL41m1qHrQxSRXihI8xuG8",
                authDomain: "smartkos13.firebaseapp.com",
                projectId: "smartkos13",
                storageBucket: "smartkos13.firebasestorage.app",
                messagingSenderId: "240191503170",
                appId: "1:240191503170:web:bf169151c9a2ad098d66db",
                measurementId: "G-H6FY9Q7SLS"
            };
            firebase.initializeApp(firebaseConfig);
        }
        const database = firebase.database();

        // Autentikasi Pengguna
        const role = localStorage.getItem('role');
        const userLogin = localStorage.getItem('username');
        const qpUser = new URLSearchParams(location.search).get('user');

        if (role !== 'user' || !userLogin || userLogin !== qpUser) {
            alert('Silakan login terlebih dahulu.');
            location.href = 'login.html?role=user';
        } else {
            document.getElementById('userName').textContent = userLogin;
        }
        
        // Ambil elemen DOM
        const relayStatusInfo = document.getElementById('relayStatusInfo');
        const monitoringBody = document.getElementById('monitoringBody');
        const paymentBtn = document.getElementById('paymentBtn');
        const billAmountEl = document.getElementById('billAmount');
        const usageInfoEl = document.getElementById('usageInfo');
        
        // Konteks grafik
        const powerChartCtx = document.getElementById('powerChart').getContext('2d');
        const voltageChartCtx = document.getElementById('voltageChart').getContext('2d');
        const currentChartCtx = document.getElementById('currentChart').getContext('2d');
        const energyChartCtx = document.getElementById('energyChart').getContext('2d');
        
        let powerChart;
        let voltageChart;
        let currentChart;
        let energyChart;
        
        let chartDataPoints = {
            power: [],
            voltage: [],
            current: [],
            energy: []
        };

        // Fungsi format angka (tetap menggunakan 2 desimal untuk sebagian besar parameter)
        function fmt(n) { return (typeof n === 'number') ? n.toFixed(2) : 'N/A'; }

        // Fungsi untuk memperbarui grafik
        function updateChart(chart, ctx, label, data, borderColor, unit) {
            const labels = chartDataPoints[data].map(p => p.x);
            const dataValues = chartDataPoints[data].map(p => p.y);

            if (chart) {
                chart.data.labels = labels;
                chart.data.datasets[0].data = dataValues;
                chart.update();
            } else {
                chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: `${label} (${unit})`,
                            data: dataValues,
                            borderColor: borderColor,
                            tension: 0.1,
                            fill: false
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: `${label} (${unit})`
                                }
                            }
                        }
                    }
                });
            }
            return chart;
        }

        // Dengarkan perubahan pada data kamar spesifik
        database.ref(userLogin).on('value', snapshot => {
            const roomData = snapshot.val();
            
            if (roomData) {
                // 1. Perbarui Status Listrik
                const isRelayOn = roomData.relay !== undefined ? roomData.relay : true;
                relayStatusInfo.innerHTML = `Status Listrik Kamar Anda: <span class="${isRelayOn ? 'paid' : 'unpaid'}">${isRelayOn ? 'NYALA' : 'MATI'}</span>`;

                // 2. Isi Tabel Monitoring Real-time
                monitoringBody.innerHTML = '';
                const meteran = roomData.meteran || {};
                
                let energyWhFromFirebase = meteran.energi_bulanan; 
                if (energyWhFromFirebase === undefined && meteran.energi !== undefined) {
                    energyWhFromFirebase = meteran.energi;
                }
                const energyKWh = (typeof energyWhFromFirebase === 'number') ? energyWhFromFirebase / 1000.0 : 0; 
                
                const monitoringRows = [
                    ['Tegangan', fmt(meteran.tegangan), 'Volt (V)'],
                    ['Arus', fmt(meteran.arus), 'Ampere (A)'],
                    ['Daya Aktif', fmt(meteran.daya_aktif), 'Watt (W)'],
                    ['Frekuensi', fmt(meteran.frekuensi), 'Hertz (Hz)'],
                    ['Faktor Daya', fmt(meteran.faktor_daya), ''],
                    ['Energi Bulanan', energyKWh.toFixed(4), 'kWh'] 
                ];

                monitoringRows.forEach(r => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td>`;
                    monitoringBody.appendChild(tr);
                });

                // 3. Perbarui Data untuk Semua Grafik
                const now = new Date();
                const timeLabel = now.toLocaleTimeString();

                chartDataPoints.power.push({ x: timeLabel, y: meteran.daya_aktif || 0 });
                chartDataPoints.voltage.push({ x: timeLabel, y: meteran.tegangan || 0 });
                chartDataPoints.current.push({ x: timeLabel, y: meteran.arus || 0 });
                chartDataPoints.energy.push({ x: timeLabel, y: energyKWh });
                
                const maxDataPoints = 10;
                if (chartDataPoints.power.length > maxDataPoints) chartDataPoints.power.shift();
                if (chartDataPoints.voltage.length > maxDataPoints) chartDataPoints.voltage.shift();
                if (chartDataPoints.current.length > maxDataPoints) chartDataPoints.current.shift();
                if (chartDataPoints.energy.length > maxDataPoints) chartDataPoints.energy.shift();

                // Perbarui atau buat grafik
                powerChart = updateChart(powerChart, powerChartCtx, 'Daya Aktif', 'power', 'rgb(75, 192, 192)', 'Watt');
                voltageChart = updateChart(voltageChart, voltageChartCtx, 'Tegangan', 'voltage', 'rgb(54, 162, 235)', 'Volt');
                currentChart = updateChart(currentChart, currentChartCtx, 'Arus', 'current', 'rgb(255, 159, 64)', 'Ampere');
                energyChart = updateChart(energyChart, energyChartCtx, 'Energi Bulanan', 'energy', 'rgb(153, 102, 255)', 'kWh');

                // 4. Hitung dan Tampilkan Tagihan
                const totalKWhBulan = energyKWh;
                const hargaDasarPerKWh = 1444.70;
                const persentasePPJ = 0.05;
                let biayaPemakaian = totalKWhBulan * hargaDasarPerKWh;

                const dayaTerpasangVA = roomData.dayaTerpasang || 1300;
                const dayaTerpasangKW = dayaTerpasangVA / 1000;
                const kwhMinimum = 40 * dayaTerpasangKW;
                const biayaMinimum = kwhMinimum * hargaDasarPerKWh;
                
                if (biayaPemakaian < biayaMinimum) {
                    biayaPemakaian = biayaMinimum;
                }

                const biayaPPJ = biayaPemakaian * persentasePPJ;
                const totalTagihan = Math.round(biayaPemakaian + biayaPPJ);

                billAmountEl.textContent = `Rp${totalTagihan.toLocaleString('id-ID')}`;
                usageInfoEl.textContent = `Berdasarkan pemakaian ${totalKWhBulan.toFixed(4)} kWh bulan ini.`;

                // 5. Siapkan Tombol Konfirmasi Pembayaran
                if (!isRelayOn) {
                    const userEncoded = encodeURIComponent(userLogin);
                    const amountEncoded = encodeURIComponent(totalTagihan);
                    paymentBtn.href = `scan.html?user=${userEncoded}&amount=${amountEncoded}`;
                    paymentBtn.style.display = 'inline-block';
                } else {
                    paymentBtn.style.display = 'none';
                }

            } else {
                relayStatusInfo.textContent = 'Status tidak diketahui';
                monitoringBody.innerHTML = '<tr><td colspan="3">Data monitoring tidak ditemukan.</td></tr>';
                billAmountEl.textContent = 'Data tidak ditemukan';
            }
        });

        // Logout
        document.getElementById('logoutBtn').onclick = e => {
            e.preventDefault();
            localStorage.removeItem('role');
            localStorage.removeItem('username');
            location.href = 'index.html';
        };
    </script>
</body>
</html>
